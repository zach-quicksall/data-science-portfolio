facet_wrap(~ pair_id, scales = "free_x") +
labs(x = "Date", y = "Spread (x - y)") +
theme_minimal() +
theme(legend.position = "bottom")
plot_df %>%
ggplot(aes(x = date, y = spread)) +
geom_line() +
geom_hline(yintercept = 0, linetype = "dashed", color = "dodgerblue") +
facet_wrap(~ pair_id, scales = "free_x") +
labs(x = "Date", y = "Spread (x - y)") +
theme_minimal() +
theme(legend.position = "bottom")
plot_df <- region_pairs %>%
left_join(cp_aug %>%
select(region_id, date, yoy_growth),
by = "region_id",
relationship = "many-to-many") %>%
select(-region_id) %>%
pivot_wider(
names_from = role,
values_from = yoy_growth
) %>%
mutate(spread = x - y,
spread_mu = mean(spread, na.rm = TRUE),
spread_sd = sd(spread, na.rm = TRUE),
z = (spread - spread_mu) / spread_sd) %>%
drop_na(spread)
plot_df %>%
ggplot(aes(x = date, y = z)) +
geom_line() +
geom_hline(yintercept = 0, linetype = "dashed", color = "dodgerblue") +
facet_wrap(~ pair_id, scales = "free_x") +
labs(x = "Date", y = "Spread Z-score (x - y)") +
theme_minimal() +
theme(legend.position = "bottom")
# Testing
df <- yoy_growth_cor_pos
head9df
head(df)
# Testing
df <- yoy_growth_cor_pos
df <- df %>%
mutate(pair_id = paste0(x, " vs ", y)) %>%
pivot_longer(-pair_id,
names_to = "role",
values_to = "region_id") %>%
left_join(cp_aug %>%
select(region_id, date, yoy_growth),
by = "region_id",
relationship = "many-to-many") %>%
select(-region_id) %>%
pivot_wider(
names_from = role,
values_from = yoy_growth
)
# Testing
df <- yoy_growth_cor_pos
df <- df %>%
mutate(x = as.character(x),
y = as.character(y),
pair_id = paste0(x, " vs ", y)) %>%
pivot_longer(-pair_id,
names_to = "role",
values_to = "region_id") %>%
left_join(cp_aug %>%
select(region_id, date, yoy_growth),
by = "region_id",
relationship = "many-to-many") %>%
select(-region_id) %>%
pivot_wider(
names_from = role,
values_from = yoy_growth
)
# Testing
df <- yoy_growth_cor_pos
str(df)
# Testing
df <- yoy_growth_cor_pos
df <- df %>%
mutate(pair_id = paste0(x, " vs ", y)) %>%
pivot_longer(-pair_id,
names_to = "role",
values_to = "region_id") %>%
left_join(cp_aug %>%
select(region_id, date, yoy_growth),
by = "region_id",
relationship = "many-to-many") %>%
select(-region_id) %>%
pivot_wider(
names_from = role,
values_from = yoy_growth
)
# Testing
df <- yoy_growth_cor_pos
str(df)
df <- df %>%
mutate(pair_id = paste0(x, " vs ", y)) %>%
pivot_longer(-pair_id,
names_to = "role",
values_to = "region_id")
# Testing
df <- yoy_growth_cor_pos
df
# Testing
df <- yoy_growth_cor_pos
df <- df %>%
mutate(pair_id = paste0(x, " vs ", y)) %>%
pivot_longer(-c(pair_id, r, n_obs),
names_to = "role",
values_to = "region_id") %>%
left_join(cp_aug %>%
select(region_id, date, yoy_growth),
by = "region_id",
relationship = "many-to-many") %>%
select(-region_id) %>%
pivot_wider(
names_from = role,
values_from = yoy_growth
)
View(head(df))
tmp <- df %>% filter(pair_id == "3418 vs 17384")
View(tmp)
df
# Testing
df <- yoy_growth_cor_pos
df <- df %>%
mutate(pair_id = paste0(x, " vs ", y)) %>%
pivot_longer(-c(pair_id, r, n_obs),
names_to = "role",
values_to = "region_id") %>%
left_join(cp_aug %>%
select(region_id, date, yoy_growth),
by = "region_id",
relationship = "many-to-many") %>%
select(-region_id) %>%
pivot_wider(
names_from = role,
values_from = yoy_growth
) %>%
select(pair_id, date, x, y, r, n_obs)
df
tar_make()
tar_load(yoy_growth_cor_pos)
# Testing
df <- yoy_growth_cor_pos
tar_load(cp_aug)
df <- df %>%
mutate(pair_id = paste0(x, " vs ", y)) %>%
pivot_longer(-c(pair_id, r, n_obs),
names_to = "role",
values_to = "region_id") %>%
left_join(cp_aug %>%
select(region_id, date, yoy_growth),
by = "region_id",
relationship = "many-to-many") %>%
select(-region_id) %>%
pivot_wider(
names_from = role,
values_from = yoy_growth
) %>%
select(pair_id, date, x, y, r, n_obs)
df
tar_load(yoy_growth_cor_neg)
# Testing
df <- yoy_growth_cor_neg
tar_load(cp_aug)
df <- df %>%
mutate(pair_id = paste0(x, " vs ", y)) %>%
pivot_longer(-c(pair_id, r, n_obs),
names_to = "role",
values_to = "region_id") %>%
left_join(cp_aug %>%
select(region_id, date, yoy_growth),
by = "region_id",
relationship = "many-to-many") %>%
select(-region_id) %>%
pivot_wider(
names_from = role,
values_from = yoy_growth
) %>%
select(pair_id, date, x, y, r, n_obs)
yoy_growth_cor_neg
nrow(yoy_growth_cor_neg)
tar_make()
tar_load(yoy_pos_growth_spreads)
yoy_pos_growth_spreads
tar_make()
tar_load(yoy_pos_growth_spreads)
View(yoy_pos_growth_spreads)
tar_load(yoy_pos_growth_spreads)
colnames(yoy_pos_growth_spreads)
plot_ids <- yoy_pos_growth_spreads %>%
select(pair_id) %>%
distinct() %>%
slice_sample(n = 12)
plot_df <- yoy_pos_growth_spreads %>%
inner_join(plot_ids, by = "pair_id")
plot_df %>%
ggplot(aes(x = date, y = z)) +
geom_line() +
geom_hline(yintercept = 0, linetype = "dashed", color = "dodgerblue") +
facet_wrap(~ pair_id, scales = "free_x") +
labs(x = "Date", y = "Spread Z-score (x - y)") +
theme_minimal() +
theme(legend.position = "bottom")
plot_df %>%
ggplot(aes(x = date)) +
geom_line(aes(y = x), color = "dodgerblue") +
geom_line(aes(y = y), color = "darkorange") +
facet_wrap(~ plot_id, scales = "free") +
labs(x = "Date", y = "YoY Growth") +
theme_minimal()
colnames(plot_df)
plot_df %>%
ggplot(aes(x = date)) +
geom_line(aes(y = x), color = "dodgerblue") +
geom_line(aes(y = y), color = "darkorange") +
facet_wrap(~ pair_id, scales = "free") +
labs(x = "Date", y = "YoY Growth") +
theme_minimal()
plot_ids <- yoy_pos_growth_spreads %>%
select(pair_id) %>%
distinct() %>%
slice_sample(n = 12)
plot_df <- yoy_pos_growth_spreads %>%
inner_join(plot_ids, by = "pair_id")
plot_df %>%
ggplot(aes(x = date)) +
geom_line(aes(y = x), color = "dodgerblue") +
geom_line(aes(y = y), color = "darkorange") +
facet_wrap(~ pair_id, scales = "free") +
labs(x = "Date", y = "YoY Growth") +
theme_minimal()
tar_make()
# Top correlated YoY regions
tar_load(yoy_pos_growth_spreads)
plot_ids <- yoy_pos_growth_spreads %>%
select(pair_id) %>%
distinct() %>%
slice_sample(n = 12)
plot_df <- yoy_pos_growth_spreads %>%
inner_join(plot_ids, by = "pair_id")
plot_df %>%
ggplot(aes(x = date)) +
geom_line(aes(y = x), color = "dodgerblue") +
geom_line(aes(y = y), color = "darkorange") +
facet_wrap(~ pair_id, scales = "free") +
labs(x = "Date", y = "YoY Growth") +
theme_minimal()
tar_load(yoy_growth_cor)
head(yoy_growth_cor)
tar_load(yoy_neg_growth_spreads)
yoy_neg_growth_spreads
tar_make()
tar_load(yoy_growth_dist)
dim(yoy_growth_dist)
head(yoy_growth_dist)
tar_make()
tar_load(yoy_growth_dist_mat)
head(yoy_growth_dist_mat)
tmp <- as.matrix(yoy_growth_dist_mat)
tmp <- as.matrix(yoy_growth_dist_mat[1:5, 1:5])
tmp
tar_make()
tar_load(yoy_growth_dist_mat)
dim(yoy_growth_dist_mat)
yoy_growth_dist_mat[1:5,1:5]
# Testing
df <- yoy_growth_cor
# Compute distance
df <- df %>%
mutate(r = 1 - r) %>%
rename(dist = r) %>%
na_replace(list(dist = 0))
# Compute distance
df <- df %>%
mutate(r = 1 - r) %>%
rename(dist = r) %>%
replace_na(list(dist = 0))
df[1:5,1:5]
# Testing
df <- yoy_growth_cor
# Compute distance
df <- df %>%
mutate(r = 1 - r) %>%
rename(dist = r) %>%
replace_na(list(dist = 0))
# Pivot to wide form
df_wide <- df %>%
select(-n_obs) %>%
pivot_wider(id_cols = x,
names_from = y,
values_from = dist) %>%
select(-x)
dim(df_wide)
df_wide[1:5,1:5]
# Testing
df <- yoy_growth_cor
# Compute distance
df <- df %>%
mutate(r = 1 - r) %>%
rename(dist = r) %>%
replace_na(list(dist = 0))
# Pivot to wide form
df_wide <- df %>%
select(-n_obs) %>%
pivot_wider(id_cols = x,
names_from = y,
values_from = dist) %>%
select(-x)
df_wide[1:5,1:5]
head(df_wide)
# Cast to matrix
df_mat <- as.matrix(df_wide)
# Pivot to wide form
df_wide <- df %>%
select(-n_obs) %>%
pivot_wider(id_cols = x,
names_from = y,
values_from = dist)
# Pivot to wide form
df_wide <- df %>%
select(-n_obs) %>%
pivot_wider(id_cols = x,
names_from = y,
values_from = dist)
# Cast to matrix
df_mat <- as.matrix(df_wide %>% select(-x))
rownames(df_mat) <- df_wide$x
df_mat[1:5,1:5]
# Testing
df <- yoy_growth_cor
# Compute distance
df <- df %>%
mutate(r = 1 - r) %>%
rename(dist = r) %>%
replace_na(list(dist = 0))
# Pivot to wide form
df_wide <- df %>%
select(-n_obs) %>%
pivot_wider(id_cols = x,
names_from = y,
values_from = dist)
# Cast to matrix
df_mat <- as.matrix(df_wide %>% select(-x))
rownames(df_mat) <- df_wide$x
# Perform hierarchical clustering
clust_res <- hclust(df_mat, method = "average")
dim(df_mat)
3728 * 3728
# Perform hierarchical clustering
clust_res <- hclust(df_mat[1:500, 1:500], method = "average")
500 * 500
anyNA(df_mat)
# Testing
df <- yoy_growth_cor
# Compute distance
df <- df %>%
mutate(r = 1 - r) %>%
rename(dist = r) %>%
mutate(dist = case_when(x == y ~ 0,
TRUE ~ dist))
df
tmp <- df %>% filter(is.na(dist))
dim(tmp)
View(tmp)
# Testing
df <- yoy_growth_cor %>%
filter(n_obs >= 10)
# Compute distance and fill diagonal with NA
df <- df %>%
mutate(r = 1 - r) %>%
rename(dist = r) %>%
mutate(dist = case_when(x == y ~ 0,
TRUE ~ dist))
# Testing
df <- yoy_growth_cor
# Filter on minimum n_obs
df <- df %>% filter(n_obs >= 10)
# Compute distance and fill diagonal with NA
df <- df %>%
mutate(r = 1 - r) %>%
rename(dist = r) %>%
mutate(dist = case_when(x == y ~ 0,
TRUE ~ dist))
# Pivot to wide form
df_wide <- df %>%
select(-n_obs) %>%
pivot_wider(id_cols = x,
names_from = y,
values_from = dist)
anyNA(df)
# Pivot to wide form
df_wide <- df %>%
select(-n_obs) %>%
pivot_wider(id_cols = x,
names_from = y,
values_from = dist)
# Cast to matrix
df_mat <- as.matrix(df_wide %>% select(-x))
rownames(df_mat) <- df_wide$x
dim(df_mat)
# Subset to regions to retain (reduce dimensionality)
keep <- colMeans(!is.na(X)) >= 0.8
# Subset to regions to retain (reduce dimensionality)
keep <- colMeans(!is.na(df_mat)) >= 0.8
length(keep)
keep
# Subset to regions to retain (reduce dimensionality)
keep <- colMeans(!is.na(df_mat)) >= 1.5
# Subset to regions to retain (reduce dimensionality)
keep <- colMeans(!is.na(df_mat)) >= 0.9
lenght(keep)
length(keep)
# Subset to regions to retain (reduce dimensionality)
keep <- colMeans(!is.na(df_mat)) >= 0.98
length(keep)
keep
View(df_mat[1:10, 1:10])
# Testing
df <- yoy_growth_cor
View(df)
?as.dist
# Testing
df <- yoy_growth_cor
# Filter on minimum n_obs
df <- df %>% filter(n_obs >= 10)
# Compute distance and fill diagonal with NA
df <- df %>%
mutate(r = 1 - abs(r)) %>%
rename(dist = r) %>%
mutate(dist = case_when(x == y ~ 0,
TRUE ~ dist))
# Pivot to wide form
df_wide <- df %>%
select(-n_obs) %>%
pivot_wider(id_cols = x,
names_from = y,
values_from = dist)
# Cast to matrix
df_mat <- as.matrix(df_wide %>% select(-x))
rownames(df_mat) <- df_wide$x
# Subset to regions to retain (reduce dimensionality)
keep <- colMeans(!is.na(df_mat)) >= 0.8
length(keep)
# Subset to regions to retain (reduce dimensionality)
keep <- colMeans(!is.na(df_mat)) >= 0.9
length(keep)
View(df_mat[1:15, 1:15])
plot_df %>%
ggplot(aes(x = date)) +
geom_line(aes(y = x), color = "dodgerblue") +
geom_line(aes(y = y), color = "darkorange") +
facet_wrap(~ pair_id, scales = "free") +
labs(x = "Date", y = "YoY Growth") +
theme_minimal()
plot_ids <- yoy_pos_growth_spreads %>%
select(pair_id) %>%
distinct() %>%
slice_sample(n = 12)
plot_df <- yoy_pos_growth_spreads %>%
inner_join(plot_ids, by = "pair_id")
plot_df %>%
ggplot(aes(x = date)) +
geom_line(aes(y = x), color = "dodgerblue") +
geom_line(aes(y = y), color = "darkorange") +
facet_wrap(~ pair_id, scales = "free") +
labs(x = "Date", y = "YoY Growth") +
theme_minimal()
plot_df %>%
ggplot(aes(x = date, y = z)) +
geom_line() +
geom_hline(yintercept = 0, linetype = "dashed", color = "dodgerblue") +
facet_wrap(~ pair_id, scales = "free_x") +
labs(x = "Date", y = "Spread Z-score (x - y)") +
theme_minimal() +
theme(legend.position = "bottom")
plot_df %>%
ggplot(aes(x = date)) +
geom_line(aes(y = x), color = "dodgerblue") +
geom_line(aes(y = y), color = "darkorange") +
facet_wrap(~ pair_id, scales = "free") +
labs(x = "Date", y = "YoY Growth") +
theme_minimal()
# Top correlated YoY regions
tar_load(yoy_pos_growth_spreads)
plot_ids <- yoy_pos_growth_spreads %>%
select(pair_id) %>%
distinct() %>%
slice_sample(n = 12)
plot_df <- yoy_pos_growth_spreads %>%
inner_join(plot_ids, by = "pair_id")
plot_df %>%
ggplot(aes(x = date)) +
geom_line(aes(y = x), color = "dodgerblue") +
geom_line(aes(y = y), color = "darkorange") +
facet_wrap(~ pair_id, scales = "free") +
labs(x = "Date", y = "YoY Growth") +
theme_minimal()
plot_ids <- yoy_pos_growth_spreads %>%
select(pair_id) %>%
distinct() %>%
slice_sample(n = 12)
plot_df <- yoy_pos_growth_spreads %>%
inner_join(plot_ids, by = "pair_id")
plot_df %>%
ggplot(aes(x = date)) +
geom_line(aes(y = x), color = "dodgerblue") +
geom_line(aes(y = y), color = "darkorange") +
facet_wrap(~ pair_id, scales = "free") +
labs(x = "Date", y = "YoY Growth") +
theme_minimal()
