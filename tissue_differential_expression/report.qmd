---
title: "Differential Gene Expression in GTEx Brain and Vascular Tissue"
author: "Zachary S. Quicksall"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    embed-resources: true
execute:
  warning: false
  message: false
---

## Executive Summary

This analysis investigates brain-specific gene expression using bulk RNA-seq data from the GTEx project. Gene expression levels were modeled using per-gene linear regression, adjusting for known technical and biological covariates including RNA integrity, sequencing batch, sex, and age. Expression data were normalized using Conditional Quantile Normalization (CQN) to account for GC content and gene length biases.

Differential expression was assessed by testing the tissue effect for brain samples relative to vascular tissue, with statistical significance determined using false discovery rate (FDR) correction. The resulting gene-level estimates highlight robust brain-associated expression patterns while demonstrating a scalable, transparent statistical workflow for high-dimensional genomics data.

---

## Data & Study Design

Gene expression data were obtained from the GTEx project, which provides bulk RNA-seq measurements across a wide range of human tissues collected from postmortem donors. Each sample represents RNA extracted from a specific tissue region, while multiple tissues may be observed for the same individual.

This analysis focuses on identifying genes whose expression differs systematically in brain tissue relative to other tissues. Only protein-coding genes were retained to simplify interpretation and ensure compatibility with downstream normalization steps.

In addition to expression measurements, the following sample-level covariates were incorporated into the analysis:

- Tissue type (SMTS) – primary variable of interest
- RNA integrity (SMRIN) – controls for RNA degradation
- RNA extraction batch (SMNABTCH) – adjust for technical artifacts
- RNA sequencing batch (SMGEBTCH) – adjust for technical artifacts
- Sex – biological covariate
- Age – modeled as a numeric approximation derived from the provided age ranges

This design allows tissue-specific effects to be estimated while controlling for major confounders commonly encountered in bulk RNA-seq studies.

---

## Preprocessing & Normalization

Raw gene expression counts were first filtered to retain protein-coding genes with sufficient expression across samples. To address known technical biases in RNA-seq data, expression values were normalized using **Conditional Quantile Normalization (CQN)**.

CQN corrects for systematic effects related to GC content and gene length, which can otherwise induce spurious differences in measured expression levels. GC content was computed directly from hg38 genomic sequences using gene coordinates, while gene length was approximated by genomic span (end − start + 1). Although exonic length can provide a more precise measure of effective transcript length, genomic span offers a pragmatic and computationally efficient approximation suitable for this analysis.

The effectiveness of CQN normalization was evaluated by examining the relationship between expression levels and GC content / gene length before and after normalization across a random subset of samples. These diagnostics confirm that systematic trends were substantially reduced following normalization.

Normalized expression values were log-transformed and used for all downstream modeling.

---

## Differential Expression Methodology

Differential expression was assessed using per-gene linear models, fit independently for each gene. For a given gene, expression was modeled as:

`expression ~ tissue + rna_integrity + extraction_batch + sequencing_batch + sex + age`

The primary coefficient of interest corresponds to the brain tissue indicator, capturing the expected change in expression associated with brain samples after adjusting for covariates.

This modeling approach offers several advantages:

- Transparent interpretation of covariate effects
- Flexibility to include multiple confounders
- Direct estimation of effect sizes and confidence intervals

For each gene, the tissue coefficient estimate and associated p-value were extracted. Multiple hypothesis testing was addressed using the Benjamini–Hochberg false discovery rate (FDR) procedure.

While specialized frameworks such as empirical Bayes shrinkage are often used in large-scale expression studies, the explicit per-gene linear modeling approach was intentionally used here to emphasize clarity, interpretability, and reproducibility. And to illustrate the utility of CQN normalization, which enables the use of traditional linear models for gene expression data, rather than restricting to the use of count-based modeling strategies.

---

## Results

```{r}
source("R/packages.R")
source("R/functions.R")
set.seed(2025)

tar_load(samples_sub)
tar_load(subjects_sub)
tar_load(counts_sub)
tar_load(cqn_fit)
tar_load(log_cqn)
tar_load(annot)
tar_load(deg_res_annot)
```

### Sample Diagnostics

```{r}
tbl <- samples_sub %>%
  group_by(SMTS) %>%
  count() %>%
  ungroup() %>%
  mutate(pct = n / sum(n) * 100)

colnames(tbl) <- c("Tissue", "Count (N)", "Percentage (%)")

tbl %>%
  knitr::kable() %>%
  kable_styling()
```

As we can see, our data set has substantially more brain tissue samples than vascular. It is important to keep the sample size and imbalance in mind when looking at the down-stream differential expression results, as such imbalances combined with large sample sizes often results in large inflation of "significant" pvalues. To coutneract this, care must be taken in incorporating effect size when ranking/selecting DEGs.

```{r}
tbl <- samples_sub %>%
  left_join(subjects_sub %>% select(SUBJID, AGE, SEX), by = "SUBJID") %>%
  group_by(SMTS) %>%
  summarise(
    n_samples = n(),
    age_mean  = mean(AGE, na.rm = TRUE),
    age_sd    = sd(AGE, na.rm = TRUE),
    pct_female = mean(SEX == 2, na.rm = TRUE) * 100,
    rin_mean  = mean(SMRIN, na.rm = TRUE)
  )

colnames(tbl) <- c("Tissue","Sample Count (N)","Age Mean","Age SD","Percent Female (%)", "RIN Mean")

tbl %>%
  knitr::kable() %>%
  kable_styling()
```

Based on these summary statistics, we see a high degree of similarity in sample age, sex, and RIN between the two tissues. Regardless, we will incorporate these factors as covariates in our differential expression models, as is often standard practice.

```{r}
tbl <- samples_sub %>%
  group_by(SMNABTCH) %>%
  count() %>%
  ungroup() %>%
  mutate(pct = n / sum(n) * 100) %>%
  arrange(desc(n))

colnames(tbl) <- c("RNA Extraction Batch","Count (N)","Percentage (%)")

tbl %>%
  knitr::kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")
```

As a rule of thumb, RIN values are typically filtered to a lower bound of 6. We will apply this filter to our samples before modeling.

```{r}
tbl <- samples_sub %>%
  group_by(SMGEBTCH) %>%
  count() %>%
  ungroup() %>%
  mutate(pct = n / sum(n) * 100) %>%
  arrange(desc(n))

colnames(tbl) <- c("Sequencing Batch","Count (N)","Percentage (%)")

tbl %>%
  knitr::kable() %>%
  kable_styling() %>%
  scroll_box(height = "300px")
```

Reflecting the summary metrics in the prior table, we see a nice a nice overlap in sample RIN distributions between the two tissue types.

```{r}
samples_sub %>%
  ggplot(aes(x = SMRIN)) +
  geom_histogram() +
  labs(x = "RIN", y = "Count (N)") +
  theme_minimal()
```

```{r}
samples_sub %>%
  ggplot(aes(x = SMRIN)) +
  geom_histogram(aes(fill = SMTS)) +
  scale_fill_manual(values = c("darkorange","dodgerblue")) +
  labs(x = "RIN", y = "Count (N)", fill = "Tissue") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

### Normalization and Bias

#### CQN Distribution

```{r}
log_cqn %>%
  pivot_longer(-ensg_id, names_to = "SAMPID", values_to = "expr") %>%
  ggplot(aes(x = expr, color = SAMPID)) +
  geom_density() +
  geom_vline(xintercept = 2, linetype = "dashed") +
  theme_minimal() +
  theme(legend.position = "none")
```

We will define our cutoff for expressed genes where the density curves begin to converge (approx. x = 2). We then subset our gene pool to only protein-coding genes with a median expression greater than 2, to create a subset of candidate genes for DEG analysis.

#### GC Bias Correction

```{r}
samples_to_plot <- sample(setdiff(colnames(log_cqn), c("ensg_id")), size = 500)

plot_df <- log_cqn %>%
  select(ensg_id, any_of(samples_to_plot)) %>%
  pivot_longer(-ensg_id, names_to = "SAMPID", values_to = "after_norm") %>%
  left_join(counts_sub %>%
               select(Name, any_of(samples_to_plot)) %>%
               pivot_longer(-Name, names_to = "SAMPID", values_to = "before_norm"),
             by = c("SAMPID","ensg_id" = "Name")) %>%
  mutate(before_norm = log(before_norm + 1)) %>%
  left_join(annot %>% select(ensembl_gene_id, gc_pct, gene_length), by = c("ensg_id" = "ensembl_gene_id"))
```

```{r}
genes_to_plot <- plot_df %>%
  select(ensg_id) %>%
  distinct() %>%
  slice_sample(n = 3000)

p1 <- plot_df %>%
  inner_join(genes_to_plot, by = "ensg_id") %>%
  ggplot(aes(x = gc_pct, y = before_norm)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  labs(x = "GC Content (%)", y = "Pre-Norm Expression") +
  theme_minimal()

p2 <- plot_df %>%
  inner_join(genes_to_plot, by = "ensg_id") %>%
  ggplot(aes(x = gc_pct, y = after_norm)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  labs(x = "GC Content (%)", y = "Post-Norm Expression") +
  theme_minimal()

p3 <- cowplot::plot_grid(p1, p2, nrow = 1)

p3
```

#### Length Bias Correction

```{r}
p1 <- plot_df %>%
  inner_join(genes_to_plot, by = "ensg_id") %>%
  ggplot(aes(x = log10(gene_length), y = before_norm)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  labs(x = "Gene Length (log10)", y = "Pre-Norm Expression") +
  theme_minimal()

p2 <- plot_df %>%
  inner_join(genes_to_plot, by = "ensg_id") %>%
  ggplot(aes(x = log10(gene_length), y = after_norm)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  labs(x = "Gene Length (log10)", y = "Post-Norm Expression") +
  theme_minimal()

p3 <- cowplot::plot_grid(p1, p2, nrow = 1)

p3
```

Conditional Quantile Normalization substantially reduced GC- and length-dependent expression bias across samples, while preserving the overall distribution of expression values.

### DEG Metrics

```{r}
deg_res_annot %>%
  ggplot(aes(x = p.value)) +
  geom_histogram() +
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "dodgerblue") +
  labs(x = "Pvalue", y = "Count (N)") +
  theme_minimal() +
  theme()
```

```{r}
deg_res_annot %>%
  ggplot(aes(x = estimate)) +
  geom_histogram() +
  geom_vline(xintercept = c(-5, 5),
             linetype = "dashed",
             color = "dodgerblue") +
  labs(x = "Beta", y = "Count (N)") +
  theme_minimal() +
  theme()
```

### Volcano Plot

```{r}
deg_res_annot %>%
  ggplot(aes(x = estimate, y = -log10(p.value), color = signif)) +
  geom_point(alpha = 0.4) +
  scale_color_manual(values = c("grey","dodgerblue")) +
  labs(x = "Beta", y = "-log10(pvalue)") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
tbl <- deg_res_annot %>%
  group_by(signif) %>%
  count() %>%
  ungroup() %>%
  mutate(pct = n / sum(n) * 100)

colnames(tbl) <- c("Significant Gene", "Count (N)", "Percentage (%)")

tbl %>%
  knitr::kable() %>%
  kable_styling()
```

### Top DEGs

```{r}
top_degs <- deg_res_annot %>%
  filter(signif) %>%
  arrange(desc(estimate)) %>%
  slice_head(n = 12) %>%
  select(ensg_id)

plot_df <- top_degs %>%
  left_join(log_cqn, by = "ensg_id") %>%
  pivot_longer(starts_with("GTEX"),
               names_to = "SAMPID",
               values_to = "expr") %>%
  left_join(samples_sub %>% select(SAMPID, SMTS), by = "SAMPID")

plot_df %>%
  ggplot(aes(x = SMTS, y = expr)) +
  geom_jitter(alpha = 0.2, width = 0.2) +
  geom_violin(aes(fill = SMTS), alpha = 0.8) +
  facet_wrap(~ ensg_id, scales = "free_y") +
  scale_fill_manual(values = c("darkorange","dodgerblue")) +
  labs(x = "Tissue", y = "Expression", subtitle = "Brain-Positive DEGs") +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
top_degs <- deg_res_annot %>%
  filter(signif) %>%
  arrange(estimate) %>%
  slice_head(n = 12) %>%
  select(ensg_id)

plot_df <- top_degs %>%
  left_join(log_cqn, by = "ensg_id") %>%
  pivot_longer(starts_with("GTEX"),
               names_to = "SAMPID",
               values_to = "expr") %>%
  left_join(samples_sub %>% select(SAMPID, SMTS), by = "SAMPID")

plot_df %>%
  ggplot(aes(x = SMTS, y = expr)) +
  geom_jitter(alpha = 0.2, width = 0.2) +
  geom_violin(aes(fill = SMTS), alpha = 0.8) +
  facet_wrap(~ ensg_id, scales = "free_y") +
  scale_fill_manual(values = c("darkorange","dodgerblue")) +
  labs(x = "Tissue", y = "Expression", subtitle = "Vessel-Positive DEGs") +
  theme_minimal() +
  theme(legend.position = "none")
```

---

## Discussion & Takeaways

This analysis identified widespread differences in gene expression between brain tissue and vascular tissues in the GTEx dataset. After adjusting for RNA quality, batch effects, sex, and age, a large fraction of protein-coding genes exhibited statistically detectable tissue-associated expression differences. This pattern is consistent with the extensive transcriptional specialization of brain tissue and reflects both strong biological signal and the substantial statistical power afforded by large sample sizes.

Given this high power, statistical significance alone is insufficient for prioritizing biologically meaningful effects. As expected in large-scale studies, many genes achieve extremely small p-values despite modest effect sizes. Accordingly, interpretation throughout this analysis emphasizes effect sizes and false discovery rate (FDR) control rather than raw p-values, aligning statistical conclusions with biological relevance.

Careful preprocessing played a central role in ensuring valid inference. Conditional Quantile Normalization (CQN) substantially reduced systematic biases related to GC content and gene length, as demonstrated by diagnostic plots across multiple samples. By explicitly verifying the removal of these technical trends, the analysis avoids conflating sequencing artifacts with genuine tissue-specific expression differences. Although gene length was approximated using genomic span rather than exonic length, the resulting bias correction was effective for the purposes of this study and provides a pragmatic trade-off between precision and computational complexity.

Differential expression was assessed using per-gene linear models, enabling transparent inclusion of multiple covariates and direct interpretation of tissue-associated coefficients. While more specialized frameworks such as empirical Bayes shrinkage can improve variance estimation in some settings, the explicit modeling approach adopted here prioritizes clarity and reproducibility. The resulting estimates align with known biological expectations for brain tissue while maintaining an interpretable statistical structure.

Several limitations should be noted. First, the analysis treats samples as independent observations, although multiple tissues may originate from the same donor. Incorporating donor-level random effects could further refine inference. Second, tissue-level comparisons aggregate heterogeneous brain regions, potentially masking region-specific expression patterns. Finally, the use of genomic span as a proxy for gene length represents an approximation that could be refined in future work using exon-level annotations.

Despite these limitations, this study demonstrates a robust and extensible workflow for bulk RNA-seq differential expression analysis. The combination of principled normalization, transparent statistical modeling, and targeted diagnostics provides a solid foundation for exploratory and confirmatory analyses in large transcriptomic datasets.

Overall, this analysis illustrates a practical and reproducible approach to identifying tissue-specific transcriptional signatures in large, heterogeneous RNA-seq datasets.